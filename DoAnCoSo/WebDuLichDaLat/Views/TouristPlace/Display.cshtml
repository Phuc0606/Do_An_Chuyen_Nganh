@model WebDuLichDaLat.Models.TouristPlace

@{
    var allImages = new List<string>();
    if (!string.IsNullOrEmpty(Model.ImageUrl))
    {
        allImages.Add(Model.ImageUrl);
    }
    if (Model.ImageUrls != null && Model.ImageUrls.Any())
    {
        allImages.AddRange(Model.ImageUrls);
    }

    double avgRating = ViewBag.AverageRating ?? 0;
    int ratingCount = ViewBag.RatingCount ?? 0;
    int rounded = (int)Math.Round(avgRating);
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

<h2 class="mb-4 text-center">Chi tiết sản phẩm</h2>

<div class="card shadow-sm bg-white rounded" style="margin: auto;">
    <div class="row g-4 align-items-center p-3">

        <!-- Ảnh sản phẩm -->
        <div class="col-md-5 text-center">
            @if (allImages.Any())
            {
                <div id="touristPlaceImagesCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="3000" style="max-height: 420px;">
                    <div class="carousel-indicators">
                        @for (int i = 0; i < allImages.Count; i++)
                        {
                            <button type="button" data-bs-target="#touristPlaceImagesCarousel" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
                        }
                    </div>
                    <div class="carousel-inner" style="max-height: 420px;">
                        @for (int i = 0; i < allImages.Count; i++)
                        {
                            <div class="carousel-item @(i == 0 ? "active" : "")">
                                <img src="@allImages[i]" alt="Hình ảnh sản phẩm @(i + 1)" class="d-block w-100 rounded mx-auto" style="max-height: 420px; object-fit: contain; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" />
                            </div>
                        }
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#touristPlaceImagesCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#touristPlaceImagesCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            }
            else
            {
                <div class="text-muted fst-italic fs-4">Không có hình ảnh</div>
            }
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="col-md-7 fs-5">
            <dl class="row">
                <dt class="col-sm-4 fw-bold">Tên sản phẩm:</dt>
                <dd class="col-sm-8">@Model.Name</dd>

                <dt class="col-sm-4 fw-bold">Hãng:</dt>
                <dd class="col-sm-8">@((Model.Region != null) ? Model.Region.Name : "Chưa có Hãng")</dd>

                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <dt class="col-sm-4 fw-bold">Mô tả:</dt>
                    <dd class="col-sm-8">@Model.Description</dd>
                }

                <dt class="col-sm-4 fw-bold">Danh mục:</dt>
                <dd class="col-sm-8">@((Model.Category != null) ? Model.Category.Name : "Chưa có danh mục")</dd>

                <!-- Trung bình Đánh giá -->
                <dt class="col-sm-4 fw-bold">Đánh giá:</dt>
                <dd class="col-sm-8">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= rounded)
                        {
                            <i class="fa-solid fa-star text-warning"></i>
                        }
                        else
                        {
                            <i class="fa-regular fa-star text-muted"></i>
                        }
                    }
                    <span class="ms-2 text-muted">(@avgRating.ToString("0.0")/5 từ @ratingCount lượt)</span>
                </dd>
            </dl>

            <!-- Nút hành động -->
            <div class="mt-4 d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3 flex-wrap">
                <form id="form-favorite" asp-controller="Favorite" asp-action="Add" method="post">
                    <input type="hidden" name="touristPlaceId" value="@Model.Id" />
                    <button type="submit" class="btn btn-outline-danger btn-lg" title="Thêm vào yêu thích">
                        <i class="bi bi-heart-fill"></i>
                    </button>
                </form>

                <form id="form-cart" asp-controller="Cart" asp-action="AddToCart" method="post" class="d-flex align-items-center gap-3 flex-wrap">
                    <input type="hidden" name="touristPlaceId" value="@Model.Id" />

                    <a asp-action="Index" class="btn btn-outline-primary btn-lg px-4">Quay lại danh sách</a>
                </form>
            </div>

            <!-- Form đánh giá -->
            <div class="mt-4">
                <form id="form-rating" asp-controller="TouristPlace" asp-action="Rate" method="post" class="d-flex gap-3 align-items-center">
                    <input type="hidden" name="touristPlaceId" value="@Model.Id" />
                    <input type="hidden" name="rating" id="ratingInput" value="0" />
                    <label class="form-label mb-0">Đánh giá sản phẩm:</label>
                    <div id="starRating" class="text-warning fs-3" style="cursor: pointer;">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <i class="fa-regular fa-star" data-value="@i"></i>
                        }
                    </div>
                    <button type="submit" class="btn btn-warning">Gửi đánh giá</button>
                </form>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.ReviewContent))
{
    <div class="review-content mt-4">
        @Html.Raw(Model.ReviewContent)
    </div>
}

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Hàm xử lý submit fetch với kiểm tra login redirect & 401/403
            async function handleSecurePost(form, successMsg, errorMsg) {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                // Nếu server trả về redirect (302) → chuyển tới trang đăng nhập
                if (response.redirected) {
                    alert("Bạn cần đăng nhập để sử dụng chức năng này!");
                    window.location.href = response.url;
                    return response;
                }

                // Nếu server trả về lỗi xác thực (401/403)
                if (response.status === 401 || response.status === 403) {
                    alert("Vui lòng đăng nhập để sử dụng chức năng này!");
                    window.location.href = "/Identity/Account/Login?returnUrl=" + encodeURIComponent(window.location.href);
                    return response;
                }

                alert(response.ok ? successMsg : errorMsg);
                return response;
            }

            // Xử lý form "Yêu thích"
            const formFavorite = document.getElementById('form-favorite');
            if (formFavorite) {
                formFavorite.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    await handleSecurePost(
                        formFavorite,
                        "Đã thêm vào yêu thích!",
                        "Lỗi khi thêm vào yêu thích."
                    );
                });
            }



            // Đánh giá sao (click để chọn số sao)
            const stars = document.querySelectorAll('#starRating i');
            const ratingInput = document.getElementById('ratingInput');
            stars.forEach(star => {
                star.addEventListener('click', function () {
                    const rating = parseInt(this.getAttribute('data-value'));
                    ratingInput.value = rating;
                    stars.forEach(s => {
                        s.classList.remove('fa-solid');
                        s.classList.add('fa-regular');
                    });
                    for (let i = 0; i < rating; i++) {
                        stars[i].classList.remove('fa-regular');
                        stars[i].classList.add('fa-solid');
                    }
                });
            });

            // Gửi đánh giá
            const formRating = document.getElementById('form-rating');
            if (formRating) {
                formRating.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const response = await handleSecurePost(
                        formRating,
                        "Cảm ơn bạn đã đánh giá!",
                        "Lỗi khi gửi đánh giá."
                    );
                    if (response.ok) location.reload();
                });
            }
        });
    </script>
}


